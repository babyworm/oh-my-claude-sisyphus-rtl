// {{PROJECT_NAME}} - Testbench
// Generated by oh-my-claude-rtl
//
// Description:
//   Testbench for {{MODULE_NAME}}

`timescale 1ns / 1ps

module tb_{{MODULE_NAME}};

    //----------------------------------------------------------------------
    // Parameters
    //----------------------------------------------------------------------

    parameter int DATA_WIDTH = 32;
    parameter int CLK_PERIOD = 10;  // 10ns = 100MHz

    //----------------------------------------------------------------------
    // Signals
    //----------------------------------------------------------------------

    logic                  clk;
    logic                  rst_n;
    logic                  valid_in;
    logic [DATA_WIDTH-1:0] data_in;
    logic                  ready_out;
    logic                  valid_out;
    logic [DATA_WIDTH-1:0] data_out;
    logic                  ready_in;

    //----------------------------------------------------------------------
    // Clock Generation
    //----------------------------------------------------------------------

    initial begin
        clk = 0;
        forever #(CLK_PERIOD/2) clk = ~clk;
    end

    //----------------------------------------------------------------------
    // DUT Instantiation
    //----------------------------------------------------------------------

    {{MODULE_NAME}} #(
        .DATA_WIDTH(DATA_WIDTH)
    ) dut (
        .clk       (clk),
        .rst_n     (rst_n),
        .valid_in  (valid_in),
        .data_in   (data_in),
        .ready_out (ready_out),
        .valid_out (valid_out),
        .data_out  (data_out),
        .ready_in  (ready_in)
    );

    //----------------------------------------------------------------------
    // Test Stimulus
    //----------------------------------------------------------------------

    initial begin
        // Initialize signals
        rst_n     = 0;
        valid_in  = 0;
        data_in   = '0;
        ready_in  = 0;

        // Wait for reset
        repeat (5) @(posedge clk);
        rst_n = 1;
        repeat (2) @(posedge clk);

        // Test 1: Basic data transfer
        $display("[%0t] Test 1: Basic data transfer", $time);
        send_data(32'hDEAD_BEEF);
        check_data(32'hDEAD_BEEF);

        // Test 2: Multiple transfers
        $display("[%0t] Test 2: Multiple transfers", $time);
        for (int i = 0; i < 10; i++) begin
            send_data(i);
            check_data(i);
        end

        // Test 3: Back-to-back transfers
        $display("[%0t] Test 3: Back-to-back transfers", $time);
        ready_in = 1;
        fork
            begin
                for (int i = 0; i < 5; i++) begin
                    send_data(i + 100);
                end
            end
            begin
                for (int i = 0; i < 5; i++) begin
                    check_data(i + 100);
                end
            end
        join

        // Test completed
        repeat (10) @(posedge clk);
        $display("\n*** TEST PASSED ***\n");
        $finish;
    end

    //----------------------------------------------------------------------
    // Tasks
    //----------------------------------------------------------------------

    task automatic send_data(input logic [DATA_WIDTH-1:0] data);
        @(posedge clk);
        valid_in = 1;
        data_in  = data;
        wait (ready_out);
        @(posedge clk);
        valid_in = 0;
        $display("[%0t] Sent data: 0x%0h", $time, data);
    endtask

    task automatic check_data(input logic [DATA_WIDTH-1:0] expected);
        ready_in = 1;
        wait (valid_out);
        @(posedge clk);
        if (data_out !== expected) begin
            $error("[%0t] Data mismatch! Expected: 0x%0h, Got: 0x%0h",
                   $time, expected, data_out);
            $finish;
        end else begin
            $display("[%0t] Received data: 0x%0h (OK)", $time, data_out);
        end
        ready_in = 0;
    endtask

    //----------------------------------------------------------------------
    // Timeout Watchdog
    //----------------------------------------------------------------------

    initial begin
        #1000000;  // 1ms timeout
        $error("Simulation timeout!");
        $finish;
    end

    //----------------------------------------------------------------------
    // Waveform Dump (for VCD)
    //----------------------------------------------------------------------

    initial begin
        $dumpfile("dump.vcd");
        $dumpvars(0, tb_{{MODULE_NAME}});
    end

endmodule
